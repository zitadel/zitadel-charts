name: 'Lint Charts'

on: 'pull_request'

jobs:

  lint:

    runs-on: 'ubuntu-latest'

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - id: 'checkout'
        name: Check The Repo Out
        uses: 'actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8' # v5.0.0
        with:
          fetch-depth: 0

      - name: Get Changed Test Relevant Files
        id: 'list-changed-test'
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46.0.5
        with:
          files: |
            charts/zitadel/templates/**
            charts/zitadel/values.yaml
            charts/zitadel/Chart.yaml

      - id: 'set-up-helm'
        name: Install Helm (The Chart Testing CLI Depends On It)
        uses: 'azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4' # v4.3.1
        with:
          version: latest
        if: steps.list-changed-test.outputs.any_changed == 'true'

      - id: 'set-up-python'
        name: Install Python (The Chart Testing CLI Depends On It)
        uses: 'actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065' # v5.6.0
        with:
          python-version: 3.11.4
        if: steps.list-changed-test.outputs.any_changed == 'true'

      - id: 'set-up-chart-testing'
        name: Install Chart Testing CLI
        uses: 'helm/chart-testing-action@0d28d3144d3a25ea2cc349d6e59901c4ff469b3b' # v2.7.0
        with:
          version: 'v3.12.0'
        if: steps.list-changed-test.outputs.any_changed == 'true'

      - id: 'list-changed'
        name: Check If The Chart Has Changes (not only comments, for example)
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        if: steps.list-changed-test.outputs.any_changed == 'true'

      - id: 'lint'
        name: Lint The Chart
        run: 'ct lint --target-branch ${{ github.event.repository.default_branch }}'
        if: steps.list-changed-test.outputs.any_changed == 'true' && steps.list-changed.outputs.changed == 'true'
