name: 'Test Charts'

on: 'pull_request'

jobs:
  test:

    runs-on: 'depot-ubuntu-24.04-8'

    permissions:
      contents: 'read'
      id-token: 'write'

    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        k8s:
          - version: v1.31
            kindest-image-tag: 'v1.31.12@sha256:0f5cc49c5e73c0c2bb6e2df56e7df189240d83cf94edfa30946482eb08ec57d2'
          - version: v1.32
            kindest-image-tag: 'v1.32.8@sha256:abd489f042d2b644e2d033f5c2d900bc707798d075e8186cb65e3f1367a9d5a1'
          - version: v1.33
            kindest-image-tag: 'v1.33.4@sha256:25a6018e48dfcaee478f4a59af81157a437f15e6e140bf103f85a2e7cd0cbbf2'
          - version: v1.34
            kindest-image-tag: 'v1.34.0@sha256:7416a61b42b1662ca6ca89f02028ac133a309a2a30ba309614e8ec94d976dc5a'

    name: 'K8s version ${{ matrix.k8s.version }}'

    steps:
      - id: 'checkout'
        name: Check The Repo Out
        uses: 'actions/checkout@v5.0.0'
        with:
          fetch-depth: 0

      - name: Get Changed Test Relevant Files
        id: 'list-changed-test'
        uses: tj-actions/changed-files@v47
        with:
          files: |
            charts/zitadel/**
            examples/**/*.yaml
            go.mod
            go.sum

      - id: 'create-kind'
        name: Create Kubernetes Cluster with KinD
        uses: 'helm/kind-action@v1.12.0'
        with:
          node_image: 'kindest/node:${{ matrix.k8s.kindest-image-tag }}'
          version: 'v0.29.0'
          config: ./charts/zitadel/acceptance_test/kindConfig.yaml

      - id: 'setup-go'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - id: 'setup-chrome'
        uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: 138

      - id: 'test'
        name: Run Go Tests
        run: 'go test -parallel 16 -p 32 ./...'

      - id: 'upload-login-failures'
        name: Upload Login Failures
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          include-hidden-files: true
          name: login-failures-${{ matrix.k8s.version }}
          path: charts/zitadel/acceptance_test/.login-failures
          retention-days: 30

      - id: 'zitadel-test-namespaces'
        name: Grep Created Namespaces
        run: |
          echo "pgInsecure=$(kubectl get namespaces --output name | grep 1-postgres-insecure | cut -d / -f 2)" >> "$GITHUB_OUTPUT"
          echo "pgSecure=$(kubectl get namespaces --output name | grep 2-postgres-secure | cut -d / -f 2)" >> "$GITHUB_OUTPUT"
          echo "refSecrets=$(kubectl get namespaces --output name | grep 3-referenced-secrets | cut -d / -f 2)" >> "$GITHUB_OUTPUT"
          echo "machineUser=$(kubectl get namespaces --output name | grep 4-machine-user | cut -d / -f 2)" >> "$GITHUB_OUTPUT"
          echo "internalTls=$(kubectl get namespaces --output name | grep 5-internal-tls | cut -d / -f 2)" >> "$GITHUB_OUTPUT"
        if: failure()

      - id: 'namespace-report-pg-insecure'
        name: Show ${{ steps.zitadel-test-namespaces.outputs.pgInsecure }} Namespace
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: failure()
        with:
          namespace: ${{ steps.zitadel-test-namespaces.outputs.pgInsecure }}

      - id: 'namespace-report-pg-secure'
        name: Show ${{ steps.zitadel-test-namespaces.outputs.pgSecure }} Namespace
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: failure()
        with:
          namespace: ${{ steps.zitadel-test-namespaces.outputs.pgSecure }}

      - id: 'namespace-report-ref-secrets'
        name: Show ${{ steps.zitadel-test-namespaces.outputs.refSecrets }} Namespace
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: failure()
        with:
          namespace: ${{ steps.zitadel-test-namespaces.outputs.refSecrets }}

      - id: 'namespace-report-machine-user'
        name: Show ${{ steps.zitadel-test-namespaces.outputs.machineUser }} Namespace
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: failure()
        with:
          namespace: ${{ steps.zitadel-test-namespaces.outputs.machineUser }}

      - id: 'namespace-report-self-signed'
        name: Show ${{ steps.zitadel-test-namespaces.outputs.internalTls }} Namespace
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: failure()
        with:
          namespace: ${{ steps.zitadel-test-namespaces.outputs.internalTls }}
