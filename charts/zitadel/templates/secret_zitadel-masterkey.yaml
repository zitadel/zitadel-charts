{{- /* Fail only if BOTH are set (inline key + external secret) */ -}}
{{- if and .Values.zitadel.masterkey .Values.zitadel.masterkeySecretName }}
{{- fail "set either .Values.zitadel.masterkey xor .Values.zitadel.masterkeySecretName" }}
{{- end }}

{{- /* If using an external Secret, do nothing here (we only reference it) */ -}}
{{- if and (not .Values.zitadel.masterkeySecretName) .Release.IsInstall -}}
{{- /* For NEW installs we are free to choose a name.
      Using the existing helper keeps continuity if you don't override it. */ -}}
{{- $name := include "zitadel.masterkeySecretName" . -}}
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ $name }}
  {{- with .Values.zitadel.masterkeyAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    {{- include "zitadel.labels" . | nindent 4 }}
immutable: true
stringData:
  masterkey: {{ ( .Values.zitadel.masterkey | default (randAlphaNum 32) ) | quote }}
{{- end -}}
